
@model WIPSystem.Web.Models.Product


@{

    ViewBag.Title = "Add";
}

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h2 class="text-uppercase text-center">Register Product Partno</h2>
        </div>
    </div>
 <div class="row">
        <div class="col-md-12 border-1 border">
            <form method="post" asp-action="Add" >
                @Html.AntiForgeryToken()
                <div class="mb-3">
                    <label asp-for="@Model.PartNo" class="control-label"></label>
                    <input asp-for="@Model.PartNo" class="form-control" />
                    <span asp-validation-for="@Model.PartNo" class="text-danger"></span>
                 </div>
                <div class="mb-3">
                    <label asp-for="@Model.CustName" class="control-label"></label>
                    <input asp-for="@Model.CustName" class="form-control" />
                    <span asp-validation-for="@Model.CustName" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="@Model.PackageSize" class="control-label"></label>
                    <input asp-for="@Model.PackageSize" class="form-control" />
                    <span asp-validation-for="@Model.PackageSize" class="text-danger"></span>
                </div>
                <div class="mb-3">
                    <label asp-for="@Model.PiecesPerBlank" class="control-label"></label>
                    <input asp-for="@Model.PiecesPerBlank" class="form-control" />
                    <span asp-validation-for="@Model.PiecesPerBlank" class="text-danger"></span>
                </div>
             
                <div class="mb-3">
                    <input type="submit" value="Add" class="btn btn-primary" />
                </div>
            </form>
        </div>
   </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            console.log('Document ready');

            // PartNumber blur event.
            $("#PartNo").blur(function () {
                console.log('Blur event triggered');
                var PartNo = $(this).val();
                console.log('PartNo:', PartNo);
                fetch('/Product/CheckPartNoExistence?partNo=' + encodeURIComponent(PartNo))
                    .then(response => response.json())
                    .then(data => {
                        if (data.exists) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'This PartNo already exists!'
                            }).then((result) => {
                                $("#PartNo").val(''); // Clear the input field.
                                $("#PartNo").focus(); // Refocus on the input field for user convenience.
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error checking PartNo:', error);
                    });
            }); // Close the blur event here

            // Move the form submit event handler outside of the blur event
            $("form").submit(function (e) {
                e.preventDefault();

                var formData = $(this).serialize();

                $.ajax({
                    type: "POST",
                    url: $(this).attr("action"),
                    data: formData,
                    success: function (response) {
                        if (response.success) {
                            Swal.fire({
                                icon: 'success',
                                title: 'PartNo Registered Successfully',
                                text: 'Kindly register the process flow?',
                                showCancelButton: true,
                                confirmButtonText: 'Yes, go to process flow',
                                cancelButtonText: 'No, stay here'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    window.location.href = "/Product/RegisterProcessFlow";

                                }
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: response.message || 'An error occurred!'
                            });
                        }
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'An error occurred during the submission!'
                        });
                    }
                });
            }); // Close the form submit event here

        }); // Close the document ready function here
    </script>
}
